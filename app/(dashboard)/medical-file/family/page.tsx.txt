'use client';

import { useEffect, useState } from 'react';
import { createClient } from '@/lib/supabase';
import AddFamilyMember from '@/components/medical-file/AddFamilyMember'; // Ø³Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…ÙƒÙˆÙ† Ø§Ù„Ø°ÙŠ Ø¨Ù†ÙŠÙ†Ø§Ù‡ Ø³Ø§Ø¨Ù‚Ø§Ù‹ Ø£Ùˆ Ù†Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§

export default function FamilyManagement() {
  const supabase = createClient();
  const [members, setMembers] = useState<any[]>([]);
  const [showAdd, setShowAdd] = useState(false);

  useEffect(() => {
    fetchFamily();
  }, []);

  const fetchFamily = async () => {
    const { data: { user } } = await supabase.auth.getUser();
    if(!user) return;

    // Ø¬Ù„Ø¨ Ø§Ù„Ø¬Ù…ÙŠØ¹ Ù…Ø§ Ø¹Ø¯Ø§ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ (self)
    const { data } = await supabase
      .from('medical_files')
      .select('*')
      .eq('user_id', user.id)
      .neq('relation', 'self'); // Ø§Ø³ØªØ¨Ø¹Ø§Ø¯ "Ø£Ù†Ø§"
    
    if(data) setMembers(data);
  };

  const handleDelete = async (id: string) => {
    if(!confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„ÙØŸ Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§ØªÙ‡ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø©!')) return;
    
    const { error } = await supabase.from('medical_files').delete().eq('id', id);
    if(!error) fetchFamily();
    else alert('Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­Ø°Ù');
  };

  return (
    <div className="p-6 dir-rtl max-w-4xl mx-auto">
      <div className="flex justify-between items-center mb-6">
        <h1 className="text-2xl font-bold text-purple-900">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦ Ù…Ù„ÙØ§Øª Ø£ÙØ±Ø§Ø¯ Ø§Ù„Ø£Ø³Ø±Ø©</h1>
        <button 
          onClick={() => setShowAdd(true)}
          className="bg-purple-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-purple-700 shadow"
        >
          + Ø¥Ø¶Ø§ÙØ© ÙØ±Ø¯ Ø¬Ø¯ÙŠØ¯
        </button>
      </div>

      {showAdd && (
        <div className="mb-8 border p-4 rounded-xl bg-gray-50 animate-in fade-in">
           <h3 className="font-bold mb-2">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ±Ø¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯</h3>
           {/* Ù†Ø¹ÙŠØ¯ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙƒÙˆÙ† Ø£Ùˆ Ù†Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ø®ØªØµØ± Ù‡Ù†Ø§ */}
           <AddFamilyMember 
             onSuccess={() => { setShowAdd(false); fetchFamily(); }} 
             onCancel={() => setShowAdd(false)} 
           />
        </div>
      )}

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        {members.length === 0 && !showAdd && (
          <p className="text-gray-500 col-span-2 text-center py-10">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø£ÙØ±Ø§Ø¯ Ù…Ø¶Ø§ÙÙŠÙ†. Ø£Ø¶Ù Ø£Ø¨Ù†Ø§Ø¡Ùƒ Ø£Ùˆ Ø²ÙˆØ¬ØªÙƒ Ù„Ù…ØªØ§Ø¨Ø¹Ø© ØµØ­ØªÙ‡Ù….</p>
        )}

        {members.map(member => (
          <div key={member.id} className="bg-white p-5 rounded-xl shadow border hover:border-purple-300 transition flex justify-between items-center">
            <div className="flex gap-4 items-center">
               <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl ${member.gender === 'male' ? 'bg-blue-100 text-blue-600' : 'bg-pink-100 text-pink-600'}`}>
                 {member.gender === 'male' ? 'ğŸ‘¦' : 'ğŸ‘§'}
               </div>
               <div>
                 <h3 className="font-bold text-lg">{member.full_name}</h3>
                 <p className="text-sm text-gray-500">
                   {member.relation} | {new Date().getFullYear() - new Date(member.birth_date).getFullYear()} Ø³Ù†Ø©
                 </p>
               </div>
            </div>
            <button 
              onClick={() => handleDelete(member.id)}
              className="text-red-500 hover:bg-red-50 p-2 rounded-full"
              title="Ø­Ø°Ù Ø§Ù„Ù…Ù„Ù"
            >
              ğŸ—‘ï¸
            </button>
          </div>
        ))}
      </div>
    </div>
  );
}